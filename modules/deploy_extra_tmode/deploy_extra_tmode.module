<?php

/**
 * @file deploy_extra_tmode.module
 * TODO: Enter file description here.
 */

/**
 * Implements hook_menu().
 */
function deploy_extra_tmode_menu() {
  $items = array();
  return $items;
}

/**
 * Implements hook_deploy_entity_alter().
 */
function deploy_extra_tmode_deploy_entity_alter(&$entity, $entity_type) {
  if (empty($entity) || empty($entity_type)) {
    return;
  }

  list(,, $bundle_name) = entity_extract_ids($entity_type, $entity);
  $instances = field_info_instances($entity_type, $bundle_name);
}

/**
 * Implements hook_deploy_operation_info().
 */
function deploy_extra_tmode_deploy_operation_info() {
  return array(
    'preprocess' => array(
      array('callback' => 'deploy_extra_tmode_preprocess_operation'),
    ),
  );
}

/**
 * Preprocess operation callback.
 */
function deploy_extra_tmode_preprocess_operation($plan_name, $entity) {
  $plan = deploy_plan_load($plan_name);
  if (!empty($plan->aggregator_config['delete_post_deploy'])) {
    deploy_manager_delete_from_plan($plan->name, $entity->__metadata['type'], $entity);
  }
}

/**
 * Implements hook_form_alter().
 */
function deploy_extra_tmode_form_alter(&$form, &$form_state, $form_id) {

  if (isset($form_state['item']) && $form_id == 'ctools_export_ui_edit_item_wizard_form') {
    $item = $form_state['item'];
    if ($item->table == 'deploy_plans') {
      $form['#submit'][] = 'deploy_extra_tmode_deployplan_edit_form_submit';

      $form['tmode'] = array(
        '#type' => 'checkbox',
        '#title' => t('Test mode'),
        '#description' => t('Check this to enable test mode without creating or updating entities on the endpoint side.'),
        '#default_value' => $item->tmode,
        '#weight' => 8,
      );

      dargs(); // TODO REMOVE
    }
  }
}

/**
 * Submit callback for Deploy Plan edit form.
 *
 * @param $form
 * @param $form_state
 */
function deploy_extra_tmode_deployplan_edit_form_submit(&$form, &$form_state) {
  // Save form values in the item object.
  if(isset($form_state['values']['tmode']) && $form_state['values']['tmode']) {
    $item = &$form_state['item'];
    $item->tmode = 1;
  }
}

/**
 * Implements hook_services_resources_alter().
 */
function deploy_extra_tmode_services_resources_alter(&$resources, &$endpoint) {
  // TODO: Add some code here.
}