<?php

/**
 * @file
 * This is the file description for Deploy Extra IEX module.
 */

// Translation context.
define('DEPLOY_EXTRA_IEX_TRANSLATE_CONTEXT', 'deploy_extra_iex');

// Include needed files.
module_load_include('inc', 'deploy_extra_iex', 'deploy_extra_iex.core');
module_load_include('inc', 'deploy_extra_iex', 'deploy_extra_iex.batch');

/**
 * Implements hook_permission().
 */
function deploy_extra_iex_permission() {
  return array(
    'administer deploy iex' => array(
      'title' => t('Administer export|import deployments'),
      'description' => t('Export and import data of entities with form or file.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function deploy_extra_iex_menu() {
  $items['admin/structure/deploy/import'] = array(
    'title' => 'Import data of entities',
    'description' => 'Import entities from file or form.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('deploy_extra_iex_entity_import_form'),
    'access arguments' => array('administer deploy iex'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 50,
    'file' => 'deploy_extra_iex.admin.inc',
  );

  $items['admin/structure/deploy/export/%uuid'] = array(
    'title' => 'Export entities to form',
    'page callback'  => 'drupal_get_form',
    'page arguments' => array('deploy_extra_iex_entity_export_form', 4),
    'access arguments' => array('administer deploy iex'),
    'file' => 'deploy_extra_iex.admin.inc',
  );

  $items['ajax/deploy/download/%uuid'] = array(
    'page callback'  => 'deploy_extra_iex_ajax_deploy_download',
    'page arguments' => array(3),
    'delivery callback' => 'ajax_deliver',
    'access arguments' => array('administer deploy iex'),
    'type' => MENU_CALLBACK,
    'file' => 'deploy_extra_iex.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_form_FORM_ID_alter_form().
 *   Alter the form and add DeployProcessorForm to table of processors.
 */
function deploy_extra_iex_form_ctools_export_ui_edit_item_wizard_form_alter(&$form, &$form_state, $form_id) {
  // Use in translation context.
  $context = array('context' => DEPLOY_EXTRA_IEX_TRANSLATE_CONTEXT);

  if (isset($form['aggregator_plugin'])) {
    // Add DeployProcessorForm to list of processors.
    $form['fieldset']['processor_plugin']['#options']['DeployProcessorForm'] = array(
      'name' => t('Form Processor', array(), $context),
      'description' => t('All entities are processed with the Batch API and output in form or file.'),
    );

    // Add after build function.
    $form['fieldset']['endpoints']['#after_build'] = array('deploy_extra_endpoints_after_build');

    // Add validate function.
    $form['fieldset']['endpoints']['#element_validate'][] = 'deploy_extra_validate_endpoints';
  }
}

/**
 * Implements hook_ctools_plugin_type().
 *   Provides export formats.
 */
function deploy_extra_iex_ctools_plugin_type() {
  return array(
    'export_formats' => array(
      'cache' => TRUE,
      'use hooks' => TRUE,
      'classes' => array('handler'),
    ),
  );
}

/**
 * Implements hook_deploy_extra_iex_export_formats().
 */
function deploy_extra_iex_deploy_extra_iex_export_formats() {
  $path = drupal_get_path('module', 'deploy_extra_iex') . '/plugins/export_formats';
  return array(
    'DeployExtraJSON' => array(
      'name' => 'JSON',
      'description' => 'Provides json export format.',
      'handler' => array(
        'class' => 'DeployExtraJSON',
        'file'  => 'DeployExtraJSON.inc',
        'path'  => $path,
      ),
    ),
    'DeployExtraYaml' => array(
      'name' => 'Yaml',
      'description' => 'Provides yaml export format.',
      'handler' => array(
        'class' => 'DeployExtraYaml',
        'file'  => 'DeployExtraYaml.inc',
        'path'  => $path,
      ),
    ),
  );
}

/**
 * Implements hook_deploy_extra_iex_methods().
 */
function deploy_extra_iex_deploy_extra_iex_methods() {
  return array(
    'form' => array(
      'export_label' => 'Push to form',
      'import_label' => 'Import from form',
      'export_callback' => 'deploy_extra_iex_form_export',
    ),
    'file_for_downloading' => array(
      'export_label' => 'Push to browser for downloading',
      'import_label' => 'none',
      'export_callback' => 'deploy_extra_iex_file_download_export',
    ),
    'file' => array(
      'export_label' => 'Push to destination on server folder',
      'import_label' => 'Import from file',
      'export_callback' => 'deploy_extra_iex_file_export',
    ),
  );
}
